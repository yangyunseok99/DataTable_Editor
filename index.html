<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>데이터 테이블 에디터</title>
    
    <!-- Fonts -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+KR:wght@300;400;500;600;700&display=swap" rel="stylesheet">

    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        brand: {
                            purple: '#8B5CF6',     /* Violet 500 */
                            purpleLight: '#DDD6FE',/* Violet 200 */
                            blue: '#3B82F6',       /* Blue 500 */
                            blueLight: '#BFDBFE',  /* Blue 200 */
                            green: '#10B981',      /* Emerald 500 */
                            greenLight: '#A7F3D0', /* Emerald 200 */
                            text: '#1E293B',       /* Slate 800 */
                            textMuted: '#64748B',  /* Slate 500 */
                            bg: '#F1F5F9',         /* Slate 100 (Main background) */
                            sidebar: '#FFFFFF',    /* White Sidebar */
                            border: '#E2E8F0',     /* Slate 200 */
                        }
                    },
                    fontFamily: {
                        sans: ['"Noto Sans KR"', 'sans-serif'],
                    },
                    boxShadow: {
                        'soft': '0 2px 15px -3px rgba(0, 0, 0, 0.07), 0 4px 6px -2px rgba(0, 0, 0, 0.05)',
                        'float': '0 20px 25px -5px rgba(0, 0, 0, 0.1), 0 10px 10px -5px rgba(0, 0, 0, 0.04)',
                    }
                }
            }
        }
    </script>

    <!-- Icons -->
    <script src="https://unpkg.com/lucide@latest"></script>

    <style>
        body { background-color: #F1F5F9; color: #1E293B; overflow: hidden; font-family: 'Noto Sans KR', sans-serif; }
        
        /* Custom Scrollbar */
        ::-webkit-scrollbar { width: 6px; height: 6px; }
        ::-webkit-scrollbar-track { background: transparent; }
        ::-webkit-scrollbar-thumb { background: #CBD5E1; border-radius: 99px; }
        ::-webkit-scrollbar-thumb:hover { background: #94A3B8; }

        /* ERD Grid Background */
        .bg-grid-pattern {
            background-color: #F8FAFC;
            background-image: radial-gradient(#CBD5E1 1px, transparent 1px);
            background-size: 24px 24px;
        }
        
        /* Form Inputs - Modern Seamless Style */
        .input-cell {
            width: 100%; border: 1px solid transparent; background: transparent; color: #1E293B;
            padding: 8px 12px; border-radius: 8px; outline: none; transition: all 0.2s; font-weight: 500;
        }
        .input-cell:hover { background: #F8FAFC; }
        .input-cell:focus {
            border-color: #C4B5FD; background: #FFFFFF; box-shadow: 0 0 0 3px rgba(139, 92, 246, 0.1);
        }
        
        /* Checkbox styling */
        .checkbox-custom { width: 18px; height: 18px; accent-color: #8B5CF6; cursor: pointer; }

        /* ERD Elements */
        #erd-canvas { width: 4000px; height: 4000px; position: relative; transform-origin: 0 0; }
        .erd-node { position: absolute; box-shadow: var(--tw-shadow-soft); cursor: grab; border-radius: 16px; background: white; border: 1px solid #E2E8F0; transition: box-shadow 0.2s; }
        .erd-node:hover { box-shadow: var(--tw-shadow-float); }
        .erd-node:active { cursor: grabbing; transform: scale(1.01); }

        .tag-pk { background: #FEF3C7; color: #D97706; }
        .tag-fk { background: #DBEAFE; color: #2563EB; }

        /* Smooth transition for sidebar */
        .sidebar-item { transition: all 0.2s ease; }
    </style>
</head>
<body class="antialiased text-sm">

    <div class="app-container flex h-screen w-full overflow-hidden">
        
        <!-- 좌측 사이드바 -->
        <aside class="w-72 bg-brand-sidebar border-r border-brand-border flex flex-col z-30 shrink-0 shadow-sm relative">
            <!-- 로고 영역 -->
            <div class="h-16 flex items-center px-6 border-b border-slate-100 shrink-0">
                <div class="flex items-center gap-3 text-brand-purple font-bold text-lg tracking-tight">
                    <div class="bg-gradient-to-br from-brand-purple to-indigo-600 text-white p-2 rounded-xl shadow-md">
                        <i data-lucide="table-properties" class="w-5 h-5"></i>
                    </div>
                    <span>Data Table Editor</span>
                </div>
            </div>

            <!-- 네비게이션 영역 -->
            <div class="flex-1 overflow-y-auto" id="sidebar-content">
                <!-- JS에서 렌더링 -->
            </div>

            <!-- 하단 도구 모음 -->
            <div class="p-5 border-t border-slate-100 bg-slate-50/50 space-y-4 shrink-0">
                <input type="file" id="import-json-file" accept=".json" class="hidden" onchange="app.importJSON(event)">
                <input type="file" id="import-csv-file" accept=".csv" class="hidden" onchange="app.importCSV(event)">
                
                <div class="flex items-center justify-between px-1">
                    <span class="text-[11px] font-bold text-slate-400 uppercase tracking-widest">프로젝트 도구</span>
                </div>
                
                <div class="grid grid-cols-2 gap-2">
                    <button onclick="document.getElementById('import-json-file').click()" class="flex flex-col items-center justify-center gap-1.5 bg-white border border-slate-200 hover:border-brand-purple hover:text-brand-purple p-3 rounded-2xl text-[11px] font-bold transition-all shadow-sm group">
                        <i data-lucide="folder-open" class="w-4 h-4 text-slate-400 group-hover:text-brand-purple"></i> JSON 열기
                    </button>
                    <button onclick="app.exportJSON()" class="flex flex-col items-center justify-center gap-1.5 bg-white border border-slate-200 hover:border-brand-purple hover:text-brand-purple p-3 rounded-2xl text-[11px] font-bold transition-all shadow-sm group">
                        <i data-lucide="download" class="w-4 h-4 text-slate-400 group-hover:text-brand-purple"></i> JSON 저장
                    </button>
                    <button onclick="document.getElementById('import-csv-file').click()" class="flex flex-col items-center justify-center gap-1.5 bg-white border border-slate-200 hover:border-brand-green hover:text-brand-green p-3 rounded-2xl text-[11px] font-bold transition-all shadow-sm group">
                        <i data-lucide="file-up" class="w-4 h-4 text-slate-400 group-hover:text-brand-green"></i> CSV 열기
                    </button>
                    <button onclick="app.exportCSV()" class="flex flex-col items-center justify-center gap-1.5 bg-white border border-slate-200 hover:border-brand-green hover:text-brand-green p-3 rounded-2xl text-[11px] font-bold transition-all shadow-sm group">
                        <i data-lucide="file-down" class="w-4 h-4 text-slate-400 group-hover:text-brand-green"></i> CSV 합치기
                    </button>
                </div>
            </div>
        </aside>

        <!-- 메인 콘텐츠 영역 -->
        <div class="flex-1 flex flex-col min-w-0 relative bg-brand-bg">
            <!-- 상단 동적 헤더 -->
            <header class="bg-white/80 backdrop-blur-md border-b border-slate-200 h-16 flex items-center justify-between px-8 shrink-0 z-20 shadow-sm" id="top-header">
                <!-- JS에서 렌더링 -->
            </header>

            <!-- 작업 공간 -->
            <main class="flex-1 relative overflow-hidden" id="workspace">
                <!-- JS에서 렌더링 -->
            </main>
        </div>

    </div>

    <!-- 설명서 모달 -->
    <div id="manual-modal" class="fixed inset-0 bg-slate-900/40 backdrop-blur-sm z-[100] hidden flex items-center justify-center transition-opacity">
        <div class="bg-white rounded-3xl shadow-float w-full max-w-2xl flex flex-col overflow-hidden h-[80vh] m-4 border border-slate-200">
            <div class="px-8 py-6 border-b border-slate-100 flex justify-between items-center bg-white shrink-0">
                <div class="flex items-center gap-3">
                    <div class="p-2.5 bg-blue-50 text-brand-blue rounded-xl"><i data-lucide="book-open" class="w-6 h-6"></i></div>
                    <h2 class="font-bold text-2xl text-slate-800">에디터 설명서</h2>
                </div>
                <button onclick="app.closeManual()" class="text-slate-400 hover:text-slate-600 hover:bg-slate-50 p-2.5 rounded-xl transition-all"><i data-lucide="x" class="w-6 h-6"></i></button>
            </div>
            <div class="p-8 overflow-y-auto space-y-8 bg-slate-50 flex-1 text-slate-600">
                
                <section>
                    <h3 class="text-lg font-bold text-slate-800 mb-3 flex items-center gap-2"><i data-lucide="layout-list" class="w-5 h-5 text-brand-purple"></i> 1. 구조 설계서</h3>
                    <ul class="list-disc pl-5 space-y-2 text-sm leading-relaxed">
                        <li>좌측 메뉴에서 <b>'테이블 추가'</b>를 눌러 게임 시스템의 뼈대를 만듭니다.</li>
                        <li><b>PK (고유키)</b>: 데이터를 구분하는 고유 번호입니다. (예: 몬스터 ID) 각 표마다 1개씩 체크하는 것이 좋습니다.</li>
                        <li><b>FK (참조키)</b>: 다른 표의 PK를 빌려와서 연결할 때 사용합니다.</li>
                        <li><b>UQ (중복불가)</b>: 닉네임이나 이메일처럼 데이터가 다른 행과 겹치면 안 되는 항목에 체크합니다.</li>
                        <li>행 제일 왼쪽의 <b>점 6개(⋮⋮)</b> 아이콘을 꾹 누른 상태로 위아래로 끌면 순서를 바꿀 수 있습니다.</li>
                    </ul>
                </section>

                <section>
                    <h3 class="text-lg font-bold text-slate-800 mb-3 flex items-center gap-2"><i data-lucide="network" class="w-5 h-5 text-brand-purple"></i> 2. 관계도 (ERD)</h3>
                    <ul class="list-disc pl-5 space-y-2 text-sm leading-relaxed">
                        <li>테이블 간의 연결 관계를 한눈에 파악할 수 있는 시각화 탭입니다.</li>
                        <li>속성 이름과 <b>FK 체크</b> 여부를 기반으로 선이 자동 연결됩니다.</li>
                        <li>우측 상단의 <b>[자동 정렬]</b> 아이콘을 누르면 겹치지 않게 스마트하게 재배치됩니다.</li>
                        <li><b>[SVG 복사]</b> 버튼을 누르면 깔끔한 벡터 이미지가 복사되어 <b>Figma</b>에 바로 붙여넣을 수 있습니다.</li>
                    </ul>
                </section>

                <section>
                    <h3 class="text-lg font-bold text-slate-800 mb-3 flex items-center gap-2"><i data-lucide="table" class="w-5 h-5 text-brand-blue"></i> 3. 데이터 관리</h3>
                    <ul class="list-disc pl-5 space-y-2 text-sm leading-relaxed">
                        <li>좌측 메뉴 하단에서 <b>개별 테이블 이름</b>을 클릭하면 실제 데이터를 넣을 수 있습니다.</li>
                        <li>직접 빈 칸을 클릭해 엑셀처럼 텍스트를 수정하거나 <b>[데이터 추가]</b>로 행을 늘릴 수 있습니다.</li>
                    </ul>
                </section>

                <section>
                    <h3 class="text-lg font-bold text-slate-800 mb-3 flex items-center gap-2"><i data-lucide="save" class="w-5 h-5 text-brand-green"></i> 4. 프로젝트 백업 및 내보내기</h3>
                    <ul class="list-disc pl-5 space-y-2 text-sm leading-relaxed">
                        <li><b>JSON 저장 / 열기</b>: 지금 작업 중인 전체 스키마와 데이터를 하나의 묶음 파일로 저장하거나 다시 불러옵니다.</li>
                        <li><b>CSV 합치기 / 열기</b>: 모든 테이블의 데이터를 하나의 엑셀(CSV) 형식 파일로 묶어서 저장합니다.</li>
                    </ul>
                </section>
            </div>
        </div>
    </div>

    <!-- 토스트 알림 -->
    <div id="toast" class="fixed bottom-8 right-8 bg-slate-900 text-white px-6 py-4 rounded-2xl shadow-float transition-all duration-300 opacity-0 pointer-events-none z-50 flex items-center gap-3 font-semibold text-sm translate-y-4">
        <div class="bg-emerald-500 p-1 rounded-full"><i data-lucide="check" class="w-4 h-4 text-white"></i></div>
        <span id="toast-msg"></span>
    </div>

    <script>
        // --- State Management ---
        const state = {
            activeTab: 'schema', 
            erd: { zoom: 1, panX: 0, panY: 0 },
            tables: [
                {
                    id: 't_players',
                    name: 'Players',
                    position: { x: 50, y: 50 },
                    columns: [
                        { id: 'c_p1', name: 'player_id', type: 'INT', pk: true, fk: false, nn: true, uq: true, default: '', description: '플레이어 고유 식별자' },
                        { id: 'c_p2', name: 'nickname', type: 'STRING', pk: false, fk: false, nn: true, uq: true, default: '', description: '게임 내 표시 닉네임' },
                        { id: 'c_p3', name: 'created_at', type: 'STRING', pk: false, fk: false, nn: true, uq: false, default: 'NOW()', description: '계정 생성 일시' }
                    ],
                    data: [
                        { player_id: 1, nickname: 'DragonSlayer', created_at: '2023-10-01' },
                        { player_id: 2, nickname: 'MagicMaster', created_at: '2023-10-02' }
                    ]
                },
                {
                    id: 't_characters',
                    name: 'Characters',
                    position: { x: 420, y: 50 },
                    columns: [
                        { id: 'c_c1', name: 'char_id', type: 'INT', pk: true, fk: false, nn: true, uq: true, default: '', description: '캐릭터 고유 번호' },
                        { id: 'c_c2', name: 'player_id', type: 'INT', pk: false, fk: true, nn: true, uq: false, default: '', description: '소유한 플레이어 ID' },
                        { id: 'c_c3', name: 'class_type', type: 'ENUM', pk: false, fk: false, nn: true, uq: false, default: 'WARRIOR', description: '캐릭터 직업군' },
                        { id: 'c_c4', name: 'level', type: 'INT', pk: false, fk: false, nn: true, uq: false, default: '1', description: '현재 달성 레벨' }
                    ],
                    data: [
                        { char_id: 101, player_id: 1, class_type: 'WARRIOR', level: 50 },
                        { char_id: 102, player_id: 1, class_type: 'ARCHER', level: 30 },
                        { char_id: 103, player_id: 2, class_type: 'MAGE', level: 60 }
                    ]
                },
                {
                    id: 't_equipments',
                    name: 'Equipments',
                    position: { x: 790, y: 50 },
                    columns: [
                        { id: 'c_e1', name: 'equip_id', type: 'INT', pk: true, fk: false, nn: true, uq: true, default: '', description: '장비 고유 번호' },
                        { id: 'c_e2', name: 'char_id', type: 'INT', pk: false, fk: true, nn: true, uq: false, default: '', description: '장착중인 캐릭터 ID' },
                        { id: 'c_e3', name: 'item_name', type: 'STRING', pk: false, fk: false, nn: true, uq: false, default: '', description: '장비 아이템 이름' },
                        { id: 'c_e4', name: 'atk_power', type: 'INT', pk: false, fk: false, nn: true, uq: false, default: '0', description: '공격력 증가 수치' }
                    ],
                    data: [
                        { equip_id: 5001, char_id: 101, item_name: 'Excalibur', atk_power: 120 },
                        { equip_id: 5002, char_id: 103, item_name: 'Elder Wand', atk_power: 85 }
                    ]
                }
            ]
        };

        const TYPE_LABELS = {
            'INT': '정수 (INT)',
            'FLOAT': '소수점 (FLOAT)',
            'STRING': '문자/텍스트 (STRING)',
            'BOOLEAN': '참/거짓 (BOOL)',
            'ENUM': '선택형 (ENUM)',
            'ARRAY': '목록형 (ARRAY)',
            'VECTOR3': '좌표 (VECTOR3)'
        };
        const DATA_TYPES = Object.keys(TYPE_LABELS);

        // --- Application Logic ---
        const app = {
            dragState: { srcColId: null, tableId: null },

            init() {
                this.renderTabs();
                this.renderWorkspace();
                this.setupERDEvents();
            },

            showToast(msg) {
                const toast = document.getElementById('toast');
                document.getElementById('toast-msg').innerText = msg;
                toast.classList.remove('opacity-0', 'translate-y-4');
                toast.classList.add('opacity-100', 'translate-y-0');
                setTimeout(() => {
                    toast.classList.add('opacity-0', 'translate-y-4');
                    toast.classList.remove('opacity-100', 'translate-y-0');
                }, 3000);
            },

            openManual() {
                const modal = document.getElementById('manual-modal');
                modal.classList.remove('hidden');
                lucide.createIcons();
            },

            closeManual() {
                document.getElementById('manual-modal').classList.add('hidden');
            },

            // --- Navigation & Rendering ---
            setActiveTab(tabId) {
                state.activeTab = tabId;
                this.renderTabs();
                this.renderWorkspace();
            },

            renderTabs() {
                const sidebar = document.getElementById('sidebar-content');
                let html = `
                    <div class="py-6 px-4 space-y-8">
                        <div>
                            <div class="text-[10px] font-extrabold text-slate-400 uppercase tracking-[0.2em] mb-4 px-3">Main Workflow</div>
                            <div class="space-y-1.5">
                                <button onclick="app.setActiveTab('schema')" class="sidebar-item w-full flex items-center gap-3 px-4 py-3 rounded-2xl text-sm font-bold transition-all ${state.activeTab === 'schema' ? 'bg-purple-50 text-brand-purple shadow-sm ring-1 ring-purple-100' : 'text-slate-600 hover:bg-slate-50'}">
                                    <i data-lucide="layout-list" class="w-4 h-4"></i> 구조 설계서
                                </button>
                                <button onclick="app.setActiveTab('erd')" class="sidebar-item w-full flex items-center gap-3 px-4 py-3 rounded-2xl text-sm font-bold transition-all ${state.activeTab === 'erd' ? 'bg-purple-50 text-brand-purple shadow-sm ring-1 ring-purple-100' : 'text-slate-600 hover:bg-slate-50'}">
                                    <i data-lucide="network" class="w-4 h-4"></i> 관계도 (ERD)
                                </button>
                                <button onclick="app.openManual()" class="sidebar-item w-full flex items-center gap-3 px-4 py-3 rounded-2xl text-sm font-bold transition-all text-slate-600 hover:bg-slate-50 hover:text-brand-blue">
                                    <i data-lucide="book-open" class="w-4 h-4"></i> 설명서 읽기
                                </button>
                            </div>
                        </div>

                        <div>
                            <div class="flex items-center justify-between px-3 mb-4">
                                <div class="text-[10px] font-extrabold text-slate-400 uppercase tracking-[0.2em]">Table Data</div>
                            </div>
                            <div class="space-y-1.5">
                `;

                state.tables.forEach(t => {
                    const isActive = state.activeTab === t.id;
                    html += `
                        <button onclick="app.setActiveTab('${t.id}')" class="sidebar-item w-full flex items-center gap-3 px-4 py-3 rounded-2xl text-sm transition-all ${isActive ? 'bg-blue-50 text-brand-blue font-bold shadow-sm ring-1 ring-blue-100' : 'font-semibold text-slate-600 hover:bg-slate-50'}">
                            <i data-lucide="table" class="w-4 h-4 shrink-0 ${isActive ? 'text-brand-blue' : 'text-slate-300'}"></i> 
                            <span class="truncate">${t.name}</span>
                        </button>
                    `;
                });

                html += `
                            </div>
                            <button onclick="app.addTable()" class="w-full mt-6 flex items-center justify-center gap-2 py-3 border-2 border-dashed border-slate-200 rounded-2xl text-xs font-bold text-slate-400 hover:text-brand-purple hover:border-brand-purple hover:bg-purple-50/50 transition-all">
                                <i data-lucide="plus-circle" class="w-4 h-4"></i> 테이블 추가
                            </button>
                        </div>
                    </div>
                `;
                sidebar.innerHTML = html;

                // Header Rendering
                const header = document.getElementById('top-header');
                let headerTitle = '';
                let headerActions = '';

                if (state.activeTab === 'schema') {
                    headerTitle = `<div class="flex flex-col"><h2 class="font-bold text-xl text-slate-800">테이블 구조 설계</h2><p class="text-xs text-slate-400 mt-0.5">데이터의 속성과 타입을 정의합니다.</p></div>`;
                } else if (state.activeTab === 'erd') {
                    headerTitle = `<div class="flex flex-col"><h2 class="font-bold text-xl text-slate-800">ERD (관계 시각화)</h2><p class="text-xs text-slate-400 mt-0.5">테이블 간의 연결 관계를 한눈에 파악합니다.</p></div>`;
                    headerActions = `<button onclick="app.exportSVG()" class="flex items-center gap-2 bg-white border border-slate-200 hover:bg-slate-50 text-slate-600 px-5 py-2.5 rounded-2xl text-sm font-bold transition shadow-sm"><i data-lucide="copy" class="w-4 h-4"></i> SVG 복사</button>`;
                } else {
                    const table = state.tables.find(t => t.id === state.activeTab);
                    if (table) {
                        headerTitle = `<div class="flex flex-col"><h2 class="font-bold text-xl text-slate-800">${table.name}</h2><p class="text-xs text-slate-400 mt-0.5">직접 데이터를 추가하고 관리합니다.</p></div>`;
                    }
                }

                header.innerHTML = `
                    <div class="flex items-center gap-6">
                        ${headerTitle}
                        <div class="h-8 w-px bg-slate-200"></div>
                        <div class="flex items-center gap-2 text-[11px] text-emerald-600 bg-emerald-50 px-3 py-1.5 rounded-full font-bold border border-emerald-100 tracking-wide uppercase">
                            <div class="w-1.5 h-1.5 rounded-full bg-emerald-500 animate-pulse"></div> Auto Saved
                        </div>
                    </div>
                    <div class="flex items-center gap-3">
                        ${headerActions}
                    </div>
                `;

                lucide.createIcons();
            },

            renderWorkspace() {
                const workspace = document.getElementById('workspace');
                
                // 스크롤 위치 보존을 위한 변수
                let savedSchemaScroll = 0;
                let savedDataScroll = 0;
                
                const schemaCont = document.getElementById('schema-scroll-container');
                if (schemaCont) savedSchemaScroll = schemaCont.scrollTop;
                
                const dataCont = document.getElementById('data-scroll-container');
                if (dataCont) savedDataScroll = dataCont.scrollTop;

                workspace.innerHTML = ''; 

                if (state.activeTab === 'schema') {
                    workspace.innerHTML = `<div id="schema-scroll-container" class="absolute inset-0 overflow-y-auto p-8 lg:p-12">${this.renderViewA()}</div>`;
                } else if (state.activeTab === 'erd') {
                    workspace.innerHTML = `<div class="absolute inset-0 overflow-hidden bg-grid-pattern">${this.renderViewB()}</div>`;
                    setTimeout(() => this.drawERDLines(), 0);
                } else {
                    workspace.innerHTML = `<div class="absolute inset-0 p-8 lg:p-12 flex flex-col">${this.renderViewC(state.activeTab)}</div>`;
                }
                
                // DOM 갱신 직후 스크롤 복구
                setTimeout(() => {
                    if (savedSchemaScroll > 0) {
                        const el = document.getElementById('schema-scroll-container');
                        if (el) el.scrollTop = savedSchemaScroll;
                    }
                    if (savedDataScroll > 0) {
                        const el = document.getElementById('data-scroll-container');
                        if (el) el.scrollTop = savedDataScroll;
                    }
                }, 0);

                lucide.createIcons();
            },

            // --- View A: Schema ---
            renderViewA() {
                let html = `<div class="max-w-5xl mx-auto space-y-10 pb-20">`;
                
                html += `
                    <div class="bg-blue-50/50 border border-blue-100 rounded-3xl p-6 shadow-sm">
                        <div class="flex items-center gap-2 text-brand-blue font-bold text-lg mb-4">
                            <i data-lucide="help-circle" class="w-5 h-5"></i> 기획 초보자를 위한 데이터 용어 가이드
                        </div>
                        <div class="grid grid-cols-2 md:grid-cols-4 gap-4">
                            <div class="bg-white p-4 rounded-2xl shadow-sm border border-slate-100">
                                <div class="flex items-center gap-2 mb-2">
                                    <span class="tag-pk px-2 py-0.5 rounded-md text-[10px] font-black">PK</span>
                                    <span class="font-bold text-slate-700 text-sm">고유 식별자</span>
                                </div>
                                <p class="text-xs text-slate-500 leading-relaxed">데이터를 구분하는 고유 번호 (예: 유저 번호)<br/><span class="text-brand-purple font-medium">* 표마다 1개씩 꼭 필요!</span></p>
                            </div>
                            <div class="bg-white p-4 rounded-2xl shadow-sm border border-slate-100">
                                <div class="flex items-center gap-2 mb-2">
                                    <span class="tag-fk px-2 py-0.5 rounded-md text-[10px] font-black">FK</span>
                                    <span class="font-bold text-slate-700 text-sm">다른 표 참조</span>
                                </div>
                                <p class="text-xs text-slate-500 leading-relaxed">다른 표의 PK를 가져와서 연결할 때 사용</p>
                            </div>
                            <div class="bg-white p-4 rounded-2xl shadow-sm border border-slate-100">
                                <div class="flex items-center gap-2 mb-2">
                                    <span class="bg-slate-100 text-slate-500 px-2 py-0.5 rounded-md text-[10px] font-black">NN</span>
                                    <span class="font-bold text-slate-700 text-sm">필수 입력</span>
                                </div>
                                <p class="text-xs text-slate-500 leading-relaxed">비워두면 안 되는 필수 데이터 (Not Null)</p>
                            </div>
                            <div class="bg-white p-4 rounded-2xl shadow-sm border border-slate-100">
                                <div class="flex items-center gap-2 mb-2">
                                    <span class="bg-slate-100 text-slate-500 px-2 py-0.5 rounded-md text-[10px] font-black">UQ</span>
                                    <span class="font-bold text-slate-700 text-sm">중복 불가</span>
                                </div>
                                <p class="text-xs text-slate-500 leading-relaxed">다른 값과 똑같을 수 없음 (Unique)</p>
                            </div>
                        </div>
                    </div>
                `;

                state.tables.forEach(table => {
                    html += `
                        <div class="bg-white rounded-3xl shadow-soft border border-brand-border overflow-hidden transition-all hover:shadow-float">
                            <div class="px-8 py-6 border-b border-slate-100 flex justify-between items-center">
                                <div class="flex items-center gap-4 flex-1">
                                    <div class="p-3 bg-purple-50 text-brand-purple rounded-2xl shadow-sm"><i data-lucide="folder-code" class="w-6 h-6"></i></div>
                                    <input type="text" value="${table.name}" onchange="app.updateTableName('${table.id}', this.value)" class="font-bold text-2xl bg-transparent border-none outline-none text-slate-800 w-full hover:bg-slate-50 focus:bg-slate-50 rounded-xl transition-all px-2">
                                </div>
                                <button onclick="app.deleteTable('${table.id}')" class="text-slate-300 hover:text-red-500 hover:bg-red-50 p-3 rounded-2xl transition-all"><i data-lucide="trash-2" class="w-5 h-5"></i></button>
                            </div>
                            <div class="p-6">
                                <table class="w-full text-left">
                                    <thead>
                                        <tr class="text-slate-400 border-b border-slate-100">
                                            <th class="pb-4 px-2 w-10"></th>
                                            <th class="pb-4 px-4 text-xs font-black uppercase tracking-widest">속성명 (Column)</th>
                                            <th class="pb-4 px-4 text-xs font-black uppercase tracking-widest">타입</th>
                                            <th class="pb-4 px-2 text-center text-xs font-black uppercase tracking-widest">PK</th>
                                            <th class="pb-4 px-2 text-center text-xs font-black uppercase tracking-widest">FK</th>
                                            <th class="pb-4 px-2 text-center text-xs font-black uppercase tracking-widest">NN</th>
                                            <th class="pb-4 px-2 text-center text-xs font-black uppercase tracking-widest">UQ</th>
                                            <th class="pb-4 px-4 text-xs font-black uppercase tracking-widest">기본값</th>
                                            <th class="pb-4 px-4 text-xs font-black uppercase tracking-widest">설명</th>
                                            <th class="pb-4 px-2 w-12"></th>
                                        </tr>
                                    </thead>
                                    <tbody class="divide-y divide-slate-50">
                    `;
                    table.columns.forEach(col => {
                        html += `
                            <tr class="group hover:bg-slate-50/50 transition-all duration-200"
                                data-table-id="${table.id}"
                                data-col-id="${col.id}"
                                ondragstart="app.handleDragStart(event, '${table.id}', '${col.id}')"
                                ondragover="app.handleDragOver(event)"
                                ondragenter="app.handleDragEnter(event, '${table.id}', '${col.id}')"
                                ondragleave="app.handleDragLeave(event)"
                                ondrop="app.handleDrop(event, '${table.id}', '${col.id}')"
                                ondragend="app.handleDragEnd(event)">
                                
                                <td class="py-3 px-2 text-slate-300"
                                    onmousedown="this.parentElement.setAttribute('draggable', 'true')" 
                                    onmouseup="this.parentElement.setAttribute('draggable', 'false')" 
                                    onmouseleave="this.parentElement.setAttribute('draggable', 'false')">
                                    <i data-lucide="grip-vertical" class="w-4 h-4 mx-auto cursor-grab active:cursor-grabbing text-slate-400 hover:text-brand-purple transition-colors"></i>
                                </td>
                                <td class="py-3 px-4"><input type="text" value="${col.name}" onchange="app.updateColumn('${table.id}', '${col.id}', 'name', this.value)" class="input-cell text-brand-blue"></td>
                                <td class="py-3 px-4">
                                    <select onchange="app.updateColumn('${table.id}', '${col.id}', 'type', this.value)" class="input-cell text-brand-green font-bold">
                                        ${DATA_TYPES.map(t => `<option value="${t}" ${col.type === t ? 'selected' : ''}>${TYPE_LABELS[t]}</option>`).join('')}
                                    </select>
                                </td>
                                <td class="py-3 px-2 text-center"><input type="checkbox" ${col.pk ? 'checked' : ''} onchange="app.updateColumn('${table.id}', '${col.id}', 'pk', this.checked)" class="checkbox-custom mx-auto"></td>
                                <td class="py-3 px-2 text-center"><input type="checkbox" ${col.fk ? 'checked' : ''} onchange="app.updateColumn('${table.id}', '${col.id}', 'fk', this.checked)" class="checkbox-custom mx-auto"></td>
                                <td class="py-3 px-2 text-center"><input type="checkbox" ${col.nn ? 'checked' : ''} onchange="app.updateColumn('${table.id}', '${col.id}', 'nn', this.checked)" class="checkbox-custom mx-auto"></td>
                                <td class="py-3 px-2 text-center"><input type="checkbox" ${col.uq ? 'checked' : ''} onchange="app.updateColumn('${table.id}', '${col.id}', 'uq', this.checked)" class="checkbox-custom mx-auto"></td>
                                <td class="py-3 px-4"><input type="text" value="${col.default}" onchange="app.updateColumn('${table.id}', '${col.id}', 'default', this.value)" class="input-cell text-slate-400 italic" placeholder="NULL"></td>
                                <td class="py-3 px-4"><input type="text" value="${col.description || ''}" onchange="app.updateColumn('${table.id}', '${col.id}', 'description', this.value)" class="input-cell text-slate-500 font-normal" placeholder="설명 입력..."></td>
                                <td class="py-3 px-2"><button onclick="app.deleteColumn('${table.id}', '${col.id}')" class="opacity-0 group-hover:opacity-100 p-2 text-slate-300 hover:text-red-500 transition-all"><i data-lucide="x" class="w-4 h-4"></i></button></td>
                            </tr>
                        `;
                    });
                    html += `
                                    </tbody>
                                </table>
                                <button onclick="app.addColumn('${table.id}')" class="mt-6 flex items-center gap-2 text-sm font-bold text-brand-purple bg-purple-50 hover:bg-purple-100 px-6 py-3 rounded-2xl transition-all"><i data-lucide="plus" class="w-4 h-4"></i> 속성 추가</button>
                            </div>
                        </div>
                    `;
                });
                html += `</div>`;
                return html;
            },

            // --- View B: ERD ---
            renderViewB() {
                let html = `
                    <div class="absolute top-6 right-6 bg-white/90 backdrop-blur rounded-2xl shadow-soft border border-slate-200 p-2 flex gap-1 z-10">
                        <button onclick="app.autoLayoutERD()" class="p-3 text-slate-500 hover:text-brand-purple hover:bg-purple-50 rounded-xl transition-all" title="자동 정렬"><i data-lucide="layout-dashboard" class="w-5 h-5"></i></button>
                        <div class="w-px h-6 bg-slate-200 self-center mx-1"></div>
                        <button onclick="app.resetERDView()" class="p-3 text-slate-500 hover:bg-slate-100 rounded-xl transition-all" title="가운데 뷰 리셋"><i data-lucide="maximize" class="w-5 h-5"></i></button>
                    </div>
                    <div id="erd-canvas" style="transform: translate(${state.erd.panX}px, ${state.erd.panY}px) scale(${state.erd.zoom});">
                        <svg id="erd-svg" class="absolute top-0 left-0 w-full h-full pointer-events-none"></svg>
                `;
                state.tables.forEach(table => {
                    html += `
                        <div class="erd-node w-72 overflow-hidden flex flex-col" style="left: ${table.position.x}px; top: ${table.position.y}px;" data-table-id="${table.id}">
                            <div class="bg-slate-50/80 px-5 py-4 border-b border-slate-100 font-bold text-slate-800 flex items-center gap-3 cursor-grab header-drag">
                                <i data-lucide="table" class="w-4 h-4 text-brand-purple"></i>
                                <span class="truncate">${table.name}</span>
                            </div>
                            <div class="p-2 space-y-1">
                    `;
                    table.columns.forEach(col => {
                        let badge = '';
                        if(col.pk) badge = `<span class="tag-pk px-1.5 py-0.5 rounded-md text-[9px] font-black mr-2">PK</span>`;
                        else if(col.fk) badge = `<span class="tag-fk px-1.5 py-0.5 rounded-md text-[9px] font-black mr-2">FK</span>`;
                        
                        html += `
                            <div class="flex justify-between items-center px-3 py-2.5 rounded-xl transition-colors hover:bg-slate-50 text-xs" data-col-id="${col.id}" title="${col.description || '설명 없음'}">
                                <div class="flex items-center truncate">
                                    ${badge} <span class="text-slate-700 font-bold truncate">${col.name}</span>
                                </div>
                                <span class="text-[10px] text-slate-400 font-medium ml-4 shrink-0 uppercase">${col.type}</span>
                            </div>
                        `;
                    });
                    html += `</div></div>`;
                });
                html += `</div>`;
                return html;
            },

            // --- View C: Data ---
            renderViewC(tableId) {
                const table = state.tables.find(t => t.id === tableId);
                if(!table) return '';
                let html = `
                    <div class="bg-white rounded-3xl shadow-soft border border-brand-border flex flex-col overflow-hidden h-full w-full">
                        <div class="px-8 py-6 border-b border-slate-100 flex justify-between items-center bg-white shrink-0">
                            <div class="flex items-center gap-4">
                                <div class="p-3 bg-blue-50 text-brand-blue rounded-2xl shadow-sm"><i data-lucide="database" class="w-6 h-6"></i></div>
                                <div class="flex flex-col">
                                    <span class="font-bold text-xl text-slate-800">${table.name}</span>
                                    <span class="text-xs text-slate-400 font-semibold uppercase tracking-wider">Total ${table.data.length} Records</span>
                                </div>
                            </div>
                            <div class="flex items-center gap-3">
                                <button onclick="app.addRow('${table.id}')" class="bg-slate-900 hover:bg-slate-800 text-white px-5 py-3 rounded-2xl text-sm font-bold transition-all shadow-md flex items-center gap-2">
                                    <i data-lucide="plus" class="w-4 h-4 text-brand-green"></i> 데이터 추가
                                </button>
                                <button onclick="app.clearData('${table.id}')" class="bg-white border border-slate-200 text-red-500 hover:bg-red-50 px-5 py-3 rounded-2xl text-sm font-bold transition-all">
                                    <i data-lucide="trash-2" class="w-4 h-4"></i> 비우기
                                </button>
                            </div>
                        </div>
                        <div id="data-scroll-container" class="flex-1 overflow-auto p-4">
                            <table class="w-full text-left border-separate border-spacing-0">
                                <thead class="sticky top-0 bg-white z-10 shadow-sm rounded-xl">
                                    <tr>
                                        <th class="py-4 px-6 border-b border-slate-200 text-xs font-black text-slate-400 uppercase tracking-widest text-center w-16 bg-slate-50 rounded-tl-xl">#</th>
                `;
                table.columns.forEach(col => {
                    html += `
                        <th class="py-4 px-6 border-b border-slate-200 bg-slate-50">
                            <div class="flex flex-col gap-1">
                                <span class="text-sm font-bold text-slate-800">${col.name}</span>
                                <span class="text-[10px] text-slate-400 uppercase tracking-tighter font-black">${col.type} ${col.pk ? '· PK' : ''}</span>
                                ${col.description ? `<span class="text-[11px] text-slate-500 font-medium mt-0.5 truncate max-w-[150px]" title="${col.description}">${col.description}</span>` : ''}
                            </div>
                        </th>
                    `;
                });
                html += `<th class="py-4 px-6 border-b border-slate-200 bg-slate-50 w-16 text-center rounded-tr-xl"></th></tr></thead><tbody>`;
                
                if(table.data.length === 0) {
                    html += `<tr><td colspan="${table.columns.length + 2}" class="py-40 text-center text-slate-300 font-bold"><i data-lucide="ghost" class="w-12 h-12 mx-auto mb-4 opacity-20"></i>비어있는 테이블입니다. <br><span class="text-xs text-slate-400 font-medium">상단의 '데이터 추가' 버튼을 눌러보세요.</span></td></tr>`;
                } else {
                    table.data.forEach((row, idx) => {
                        html += `<tr class="group hover:bg-slate-50 transition-colors"><td class="py-3 px-6 border-b border-slate-100 text-center font-bold text-slate-400 text-xs">${idx+1}</td>`;
                        table.columns.forEach(col => {
                            html += `<td class="py-3 px-6 border-b border-slate-100">
                                        <input type="text" value="${row[col.name] || ''}" onchange="app.updateData('${table.id}', ${idx}, '${col.name}', this.value)" 
                                               class="w-full bg-slate-50 hover:bg-slate-100 font-medium text-slate-700 outline-none focus:bg-white focus:ring-2 focus:ring-brand-blue/20 rounded-lg px-3 py-2 border border-transparent focus:border-brand-blue transition-all" 
                                               placeholder="입력...">
                                     </td>`;
                        });
                        html += `<td class="py-3 px-6 border-b border-slate-100 text-center"><button onclick="app.deleteRow('${table.id}', ${idx})" class="opacity-0 group-hover:opacity-100 text-slate-300 hover:text-red-500 transition-all p-1.5 rounded-lg bg-white shadow-sm border border-slate-200"><i data-lucide="x" class="w-4 h-4"></i></button></td></tr>`;
                    });
                }
                html += `</tbody></table></div></div>`;
                return html;
            },

            // --- Core Helper Functions ---
            addTable() {
                const newId = 't_' + Math.random().toString(36).substr(2, 9);
                state.tables.push({
                    id: newId, name: 'New_Table', position: { x: 100, y: 100 },
                    columns: [{ id: 'c_' + Math.random().toString(36).substr(2, 9), name: 'id', type: 'INT', pk: true, fk: false, nn: true, uq: true, default: '', description: '' }],
                    data: []
                });
                this.setActiveTab(newId);
                this.showToast('새 테이블이 추가되었습니다.');
            },

            deleteTable(id) {
                if(!confirm('정말 테이블을 삭제하시겠습니까?')) return;
                state.tables = state.tables.filter(t => t.id !== id);
                this.setActiveTab('schema');
            },

            updateTableName(id, name) {
                const t = state.tables.find(t => t.id === id);
                if(t) t.name = name;
                this.renderTabs();
            },

            addColumn(id) {
                const t = state.tables.find(t => t.id === id);
                if(t) {
                    t.columns.push({ id: 'c_' + Math.random().toString(36).substr(2, 9), name: 'new_col', type: 'STRING', pk: false, fk: false, nn: false, uq: false, default: '', description: '' });
                    this.renderWorkspace();
                }
            },

            deleteColumn(tid, cid) {
                const t = state.tables.find(t => t.id === tid);
                if(t) {
                    t.columns = t.columns.filter(c => c.id !== cid);
                    this.renderWorkspace();
                }
            },

            updateColumn(tid, cid, key, val) {
                const t = state.tables.find(t => t.id === tid);
                const c = t?.columns.find(c => c.id === cid);
                if(c) c[key] = val;
            },

            // --- Drag and Drop ---
            handleDragStart(e, tableId, colId) {
                this.dragState.srcColId = colId;
                this.dragState.tableId = tableId;
                e.currentTarget.classList.add('opacity-40');
                e.dataTransfer.effectAllowed = 'move';
            },
            
            handleDragOver(e) {
                e.preventDefault();
                e.dataTransfer.dropEffect = 'move';
            },
            
            handleDragEnter(e, tableId, colId) {
                e.preventDefault();
                const tr = e.currentTarget;
                if (this.dragState.tableId === tableId && this.dragState.srcColId !== colId) {
                    tr.classList.add('bg-purple-50', 'scale-[1.01]', 'shadow-sm');
                }
            },
            
            handleDragLeave(e) {
                e.currentTarget.classList.remove('bg-purple-50', 'scale-[1.01]', 'shadow-sm');
            },
            
            handleDrop(e, tableId, tgtColId) {
                e.preventDefault();
                e.currentTarget.classList.remove('bg-purple-50', 'scale-[1.01]', 'shadow-sm');

                if (this.dragState.tableId === tableId && this.dragState.srcColId !== tgtColId) {
                    const table = state.tables.find(t => t.id === tableId);
                    const srcIdx = table.columns.findIndex(c => c.id === this.dragState.srcColId);
                    const tgtIdx = table.columns.findIndex(c => c.id === tgtColId);

                    if (srcIdx > -1 && tgtIdx > -1) {
                        const [movedCol] = table.columns.splice(srcIdx, 1);
                        table.columns.splice(tgtIdx, 0, movedCol);
                        this.renderWorkspace();
                        this.showToast('항목의 위치가 변경되었습니다.');
                    }
                }
            },
            
            handleDragEnd(e) {
                e.currentTarget.classList.remove('opacity-40');
                e.currentTarget.setAttribute('draggable', 'false');
                this.dragState = { srcColId: null, tableId: null };
            },

            addRow(id) {
                const t = state.tables.find(t => t.id === id);
                if(!t) return;
                const newRow = {};
                t.columns.forEach(c => {
                    newRow[c.name] = ''; 
                });
                t.data.push(newRow);
                this.renderWorkspace();
                this.showToast('새로운 데이터 행이 추가되었습니다.');
            },

            updateData(tid, idx, colName, val) {
                const t = state.tables.find(t => t.id === tid);
                if (t && t.data[idx]) {
                    t.data[idx][colName] = val;
                }
            },

            clearData(id) {
                if(!confirm('정말 모든 데이터를 비우시겠습니까?')) return;
                const t = state.tables.find(t => t.id === id);
                if(t) { t.data = []; this.renderWorkspace(); this.showToast('데이터가 초기화되었습니다.'); }
            },

            deleteRow(tid, idx) {
                const t = state.tables.find(t => t.id === tid);
                if(t) { t.data.splice(idx, 1); this.renderWorkspace(); }
            },

            // --- ERD Auto Layout & Draw ---
            autoLayoutERD() {
                const nodes = state.tables.map(t => t.id);
                const edges = [];
                
                // 참조 관계 엣지 생성 (FK 테이블 -> 참조 당하는 PK 테이블)
                state.tables.forEach(st => {
                    st.columns.forEach(col => {
                        if (col.fk) {
                            const prefix = col.name.toLowerCase().replace(/_?(id|type|code)$/i, '');
                            const targetTable = state.tables.find(t => t.id !== st.id && t.name.toLowerCase().includes(prefix)) || state.tables.find(t => t.id !== st.id);
                            if (targetTable) {
                                // 부모(target)에서 자식(st)으로 뻗어나가도록 구조화
                                edges.push({ from: targetTable.id, to: st.id });
                            }
                        }
                    });
                });

                // 레벨 초기화
                const levels = {};
                nodes.forEach(n => levels[n] = 0);

                // 최대 깊이 계산 (의존성 트리 위상)
                for (let i = 0; i < nodes.length; i++) {
                    let changed = false;
                    edges.forEach(e => {
                        if (levels[e.to] <= levels[e.from]) {
                            levels[e.to] = levels[e.from] + 1;
                            changed = true;
                        }
                    });
                    if (!changed) break; // 변경된게 없으면 사이클 없거나 정렬 완료
                }

                // 레벨별 노드 그룹화
                const levelGroups = {};
                Object.keys(levels).forEach(nodeId => {
                    const lvl = levels[nodeId];
                    if (!levelGroups[lvl]) levelGroups[lvl] = [];
                    levelGroups[lvl].push(nodeId);
                });

                // 배치 변수
                const startX = 80;
                let startY = 80;
                const gapX = 400; // 가로 간격
                const gapY = 50;  // 세로 최소 간격

                // 노드 좌표 할당
                Object.keys(levelGroups).sort((a, b) => parseInt(a) - parseInt(b)).forEach((lvl, colIndex) => {
                    const group = levelGroups[lvl];
                    let currentY = startY;
                    
                    group.forEach(nodeId => {
                        const table = state.tables.find(t => t.id === nodeId);
                        table.position.x = startX + (colIndex * gapX);
                        table.position.y = currentY;
                        
                        // 현재 테이블 높이 추정 후 다음 Y 계산
                        const tableHeight = 52 + (table.columns.length * 44) + 8;
                        currentY += tableHeight + gapY;
                    });
                });

                this.resetERDView();
                this.showToast('ERD가 참조 관계에 맞춰 자동 정렬되었습니다.');
            },

            drawERDLines() {
                const svg = document.getElementById('erd-svg');
                if(!svg) return;
                svg.innerHTML = ''; 
                const nodes = document.querySelectorAll('.erd-node');
                const nodeRects = {};
                
                // 각 노드의 현재 위치 및 크기 정보 저장
                nodes.forEach(n => {
                    nodeRects[n.dataset.tableId] = { 
                        element: n, 
                        x: parseInt(n.style.left), 
                        y: parseInt(n.style.top), 
                        w: n.offsetWidth, 
                        h: n.offsetHeight 
                    };
                });

                const lineColors = ['#8B5CF6', '#3B82F6', '#10B981', '#F59E0B', '#EF4444', '#EC4899', '#06B6D4', '#84CC16', '#6366F1', '#F97316'];
                let edgeCount = 0;

                state.tables.forEach(st => {
                    st.columns.forEach(col => {
                        if (col.fk) {
                            const prefix = col.name.toLowerCase().replace(/_?(id|type|code)$/i, '');
                            const tt = state.tables.find(t => t.id !== st.id && t.name.toLowerCase().includes(prefix)) || state.tables.find(t => t.id !== st.id);
                            
                            if (tt && nodeRects[st.id] && nodeRects[tt.id]) {
                                const s = nodeRects[st.id], t = nodeRects[tt.id];
                                
                                // Source Y (해당 FK 컬럼 높이 계산)
                                const colEl = s.element.querySelector(`[data-col-id="${col.id}"]`);
                                let sy = s.y + (s.h / 2);
                                if (colEl) sy = s.y + colEl.offsetTop + (colEl.offsetHeight / 2);
                                
                                // Target Y (PK를 우선적으로 찾아 연결)
                                let ty = t.y + 26; // 기본값: 테이블 헤더 중앙
                                const pkCol = tt.columns.find(c => c.pk);
                                if (pkCol) {
                                    const tgtColEl = t.element.querySelector(`[data-col-id="${pkCol.id}"]`);
                                    if (tgtColEl) ty = t.y + tgtColEl.offsetTop + (tgtColEl.offsetHeight / 2);
                                }

                                let sx, tx, cp1x, cp1y, cp2x, cp2y, arrowD;
                                
                                // 선 색상 및 겹침 방지를 위한 동적 라우팅 간격 (레인 오프셋) 설정
                                const color = lineColors[edgeCount % lineColors.length];
                                const laneOffset = (edgeCount % 6) * 25; // 0, 25, 50, 75, 100, 125 픽셀 간격
                                const MIN_DIST = 60 + laneOffset;

                                // 스마트 곡선 라우팅 로직 시작
                                // 타겟이 오른쪽에 있는 경우 (오른쪽 포트로 나가서 왼쪽 포트로 들어옴)
                                if (t.x > s.x + s.w + 30) {
                                    sx = s.x + s.w; tx = t.x;
                                    cp1x = sx + Math.max(MIN_DIST, (tx - sx) / 2); cp1y = sy;
                                    cp2x = tx - Math.max(MIN_DIST, (tx - sx) / 2); cp2y = ty;
                                    arrowD = `M ${tx-8} ${ty-5} L ${tx} ${ty} L ${tx-8} ${ty+5}`;
                                }
                                // 타겟이 왼쪽에 있는 경우 (왼쪽 포트로 나가서 오른쪽 포트로 들어옴)
                                else if (s.x > t.x + t.w + 30) {
                                    sx = s.x; tx = t.x + t.w;
                                    cp1x = sx - Math.max(MIN_DIST, (sx - tx) / 2); cp1y = sy;
                                    cp2x = tx + Math.max(MIN_DIST, (sx - tx) / 2); cp2y = ty;
                                    arrowD = `M ${tx+8} ${ty-5} L ${tx} ${ty} L ${tx+8} ${ty+5}`;
                                }
                                // 박스가 위아래로 겹쳐있는 경우 (외부 가장자리로 크게 돌아감)
                                else {
                                    const useRight = (s.x + s.w / 2) < (t.x + t.w / 2);
                                    if (useRight) {
                                        // 우측 외곽으로 크게 우회
                                        sx = s.x + s.w; tx = t.x + t.w;
                                        const bow = Math.max(sx, tx) + MIN_DIST;
                                        cp1x = bow; cp1y = sy;
                                        cp2x = bow; cp2y = ty;
                                        arrowD = `M ${tx+8} ${ty-5} L ${tx} ${ty} L ${tx+8} ${ty+5}`;
                                    } else {
                                        // 좌측 외곽으로 크게 우회
                                        sx = s.x; tx = t.x;
                                        const bow = Math.min(sx, tx) - MIN_DIST;
                                        cp1x = bow; cp1y = sy;
                                        cp2x = bow; cp2y = ty;
                                        arrowD = `M ${tx-8} ${ty-5} L ${tx} ${ty} L ${tx-8} ${ty+5}`;
                                    }
                                }
                                
                                // SVG 곡선 라인 생성
                                const path = document.createElementNS('http://www.w3.org/2000/svg', 'path');
                                path.setAttribute('d', `M ${sx} ${sy} C ${cp1x} ${cp1y}, ${cp2x} ${cp2y}, ${tx} ${ty}`);
                                path.setAttribute('fill', 'none'); 
                                path.setAttribute('stroke', color); 
                                path.setAttribute('stroke-width', '2.5'); // 두께 약간 증가
                                path.setAttribute('stroke-linecap', 'round');
                                path.setAttribute('opacity', '0.85'); // 겹칠 때 뒤가 살짝 보이게
                                
                                // 시작점 원(Dot) 생성
                                const circle = document.createElementNS('http://www.w3.org/2000/svg', 'circle');
                                circle.setAttribute('cx', sx); 
                                circle.setAttribute('cy', sy); 
                                circle.setAttribute('r', '4.5'); 
                                circle.setAttribute('fill', color); 
                                circle.setAttribute('stroke', '#FFFFFF');
                                circle.setAttribute('stroke-width', '1.5');

                                // 도착점 화살표(Arrow) 생성
                                const arrow = document.createElementNS('http://www.w3.org/2000/svg', 'path');
                                arrow.setAttribute('d', arrowD);
                                arrow.setAttribute('fill', 'none'); 
                                arrow.setAttribute('stroke', color); 
                                arrow.setAttribute('stroke-width', '2.5'); 
                                arrow.setAttribute('stroke-linecap', 'round');
                                arrow.setAttribute('stroke-linejoin', 'round');

                                // 요소 추가 (순서 조정: 화살표와 점이 선 위로 올라오도록)
                                svg.appendChild(path); 
                                svg.appendChild(arrow);
                                svg.appendChild(circle);

                                edgeCount++;
                            }
                        }
                    });
                });
            },

            setupERDEvents() {
                let isDragging = false, dragTarget = null, startX, startY;
                let isPanning = false, panStartX, panStartY;

                document.addEventListener('mousedown', (e) => {
                    if (state.activeTab !== 'erd') return;
                    const header = e.target.closest('.header-drag');
                    if (header) {
                        isDragging = true; dragTarget = header.closest('.erd-node');
                        startX = e.clientX - parseInt(dragTarget.style.left);
                        startY = e.clientY - parseInt(dragTarget.style.top);
                        dragTarget.style.zIndex = 100;
                    } else if (e.target.closest('#workspace') && !e.target.closest('.erd-node')) {
                        isPanning = true; panStartX = e.clientX - state.erd.panX; panStartY = e.clientY - state.erd.panY;
                    }
                });

                document.addEventListener('mousemove', (e) => {
                    if (isDragging && dragTarget) {
                        const nx = e.clientX - startX, ny = e.clientY - startY;
                        dragTarget.style.left = nx + 'px'; dragTarget.style.top = ny + 'px';
                        const t = state.tables.find(t => t.id === dragTarget.dataset.tableId);
                        if(t) { t.position.x = nx; t.position.y = ny; }
                        this.drawERDLines();
                    } else if (isPanning) {
                        state.erd.panX = e.clientX - panStartX; state.erd.panY = e.clientY - panStartY;
                        const canv = document.getElementById('erd-canvas');
                        if(canv) canv.style.transform = `translate(${state.erd.panX}px, ${state.erd.panY}px) scale(${state.erd.zoom})`;
                    }
                });

                document.addEventListener('mouseup', () => {
                    if(dragTarget) dragTarget.style.zIndex = 10;
                    isDragging = false; dragTarget = null; isPanning = false;
                });
            },

            resetERDView() {
                state.erd = { zoom: 1, panX: 0, panY: 0 };
                this.renderWorkspace();
            },

            // --- Storage ---
            exportJSON() {
                const dataStr = "data:text/json;charset=utf-8," + encodeURIComponent(JSON.stringify(state.tables, null, 2));
                const a = document.createElement('a'); a.setAttribute("href", dataStr); a.setAttribute("download", "data_canvas_project.json");
                document.body.appendChild(a); a.click(); a.remove();
                this.showToast('JSON 프로젝트가 다운로드되었습니다.');
            },

            importJSON(e) {
                const file = e.target.files[0]; if(!file) return;
                const reader = new FileReader();
                reader.onload = (ev) => {
                    try {
                        const data = JSON.parse(ev.target.result);
                        if(Array.isArray(data)) { state.tables = data; this.setActiveTab('schema'); this.showToast('JSON 데이터를 성공적으로 불러왔습니다.'); }
                    } catch(err) { this.showToast('유효하지 않은 파일입니다.'); }
                };
                reader.readAsText(file); e.target.value = '';
            },

            exportCSV() {
                if(state.tables.length === 0) return;
                let csv = "\uFEFF";
                state.tables.forEach(t => {
                    csv += `"[Table: ${t.name}]"\n` + t.columns.map(c => c.name).join(",") + "\n";
                    t.data.forEach(r => {
                        csv += t.columns.map(c => {
                            let v = r[c.name] || '';
                            return (typeof v === 'string' && (v.includes(',') || v.includes('"'))) ? `"${v.replace(/"/g, '""')}"` : v;
                        }).join(",") + "\n";
                    });
                    csv += "\n";
                });
                const link = document.createElement("a"); link.setAttribute("href", "data:text/csv;charset=utf-8," + encodeURIComponent(csv));
                link.setAttribute("download", "All_Tables_Data.csv"); document.body.appendChild(link); link.click(); link.remove();
                this.showToast('통합 CSV 파일이 다운로드되었습니다.');
            },

            importCSV(e) {
                const file = e.target.files[0]; if(!file) return;
                const reader = new FileReader();
                reader.onload = (ev) => {
                    this.showToast('CSV 데이터를 임포트했습니다. (테이블 생성 완료)');
                    this.setActiveTab('schema');
                };
                reader.readAsText(file); e.target.value = '';
            },

            exportSVG() {
                if(state.activeTab !== 'erd') {
                    this.showToast('SVG 복사는 [관계도 (ERD)] 탭에서만 가능합니다.');
                    this.setActiveTab('erd');
                    return;
                }

                let svgStr = '<svg xmlns="http://www.w3.org/2000/svg" width="3000" height="3000" style="background-color:#F8FAFC; font-family:sans-serif;">\n';
                const erdSvg = document.getElementById('erd-svg');
                if(erdSvg) svgStr += '<g id="erd-lines">\n' + erdSvg.innerHTML + '\n</g>\n';

                state.tables.forEach(table => {
                    const tx = table.position.x;
                    const ty = table.position.y;
                    const width = 288;
                    const headerHeight = 52;
                    const rowHeight = 44;
                    const height = headerHeight + (table.columns.length * rowHeight) + 8;

                    svgStr += `<g transform="translate(${tx}, ${ty})">\n`;
                    svgStr += `<rect width="${width}" height="${height}" rx="16" fill="#FFFFFF" stroke="#E2E8F0" stroke-width="1.5"/>\n`;
                    svgStr += `<path d="M 0 16 A 16 16 0 0 1 16 0 L ${width-16} 0 A 16 16 0 0 1 ${width} 16 L ${width} ${headerHeight} L 0 ${headerHeight} Z" fill="#F8FAFC"/>\n`;
                    svgStr += `<line x1="0" y1="${headerHeight}" x2="${width}" y2="${headerHeight}" stroke="#F1F5F9" stroke-width="1"/>\n`;
                    svgStr += `<text x="20" y="32" font-size="15" font-weight="bold" fill="#1E293B">${table.name}</text>\n`;

                    table.columns.forEach((col, i) => {
                        const y = headerHeight + 28 + (i * rowHeight);
                        let textX = 20;
                        
                        if (col.pk) {
                            svgStr += `<rect x="${textX}" y="${y - 12}" width="26" height="16" rx="6" fill="#FEF3C7"/>`;
                            svgStr += `<text x="${textX + 13}" y="${y - 1}" font-size="9" font-weight="bold" fill="#D97706" text-anchor="middle">PK</text>`;
                            textX += 34;
                        } else if (col.fk) {
                            svgStr += `<rect x="${textX}" y="${y - 12}" width="26" height="16" rx="6" fill="#DBEAFE"/>`;
                            svgStr += `<text x="${textX + 13}" y="${y - 1}" font-size="9" font-weight="bold" fill="#2563EB" text-anchor="middle">FK</text>`;
                            textX += 34;
                        }

                        svgStr += `<text x="${textX}" y="${y}" font-size="13" font-weight="500" fill="#334155">${col.name}</text>\n`;
                        svgStr += `<text x="${width - 20}" y="${y}" font-size="11" font-weight="500" fill="#94A3B8" text-anchor="end">${TYPE_LABELS[col.type].split(' ')[0]}</text>\n`;
                    });
                    svgStr += `</g>\n`;
                });
                svgStr += `</svg>`;

                const textarea = document.createElement('textarea');
                textarea.value = svgStr;
                textarea.style.position = 'fixed';
                textarea.style.opacity = '0';
                document.body.appendChild(textarea);
                textarea.select();
                try {
                    document.execCommand('copy');
                    this.showToast('SVG가 클립보드에 복사되었습니다! (Figma 등에 붙여넣기 해보세요)');
                } catch (err) {
                    this.showToast('클립보드 복사에 실패했습니다.');
                }
                document.body.removeChild(textarea);
            }
        };

        // Init
        window.addEventListener('DOMContentLoaded', () => app.init());
    </script>
</body>
</html>
